
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deep Sea Reset | Admin Protected</title>
  <style>
    :root {
      --sea-blue: #0077be;
      --deep-ocean: #001a33;
      --neon-cyan: #00f2ff;
      --alert-red: #ff4d4d;
      --success-green: #00ff88;
      --sun-ray: rgba(255, 255, 255, 0.2);
    }

    body {
      font-family: 'Space Mono', monospace;
      display: flex; justify-content: center; align-items: center;
      height: 100vh; margin: 0;
      background: linear-gradient(to bottom, var(--sea-blue), var(--deep-ocean));
      overflow: hidden; color: #fff;
    }

    /* BACKGROUND ELEMENTS */
    .sun-rays {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-conic-gradient(from 180deg at 50% 0%, transparent 0deg 10deg, var(--sun-ray) 15deg 25deg, transparent 30deg);
      filter: blur(20px); animation: ray-move 20s infinite linear; z-index: -1;
    }
    @keyframes ray-move { from { transform: rotate(0deg); } to { transform: rotate(10deg); } }

    .fish { position: absolute; font-size: 2rem; pointer-events: none; z-index: 1; opacity: 0.7; }
    .fish-r2l { animation: swim-r2l 15s linear infinite; }
    .fish-l2r { animation: swim-l2r 18s linear infinite; }
    @keyframes swim-r2l { 0% { right: -10%; } 100% { right: 110%; } }
    @keyframes swim-l2r { 0% { left: -10%; transform: scaleX(-1); } 100% { left: 110%; transform: scaleX(-1); } }

    /* UI CARD */
    .card {
      position: relative; width: 100%; max-width: 400px; padding: 2.5rem;
      border-radius: 30px; background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(25px); border: 1px solid rgba(0, 242, 255, 0.4);
      box-shadow: 0 0 50px rgba(0, 119, 190, 0.5); z-index: 10; text-align: center;
    }

    h2 { font-size: 1.8rem; color: var(--neon-cyan); text-shadow: 0 0 15px var(--neon-cyan); margin-bottom: 1.5rem; }

    .input-container { transition: all 0.5s ease; }
    .hidden { display: none; opacity: 0; }

    input {
      width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px;
      color: white; margin-bottom: 1rem; outline: none; box-sizing: border-box;
    }
    input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }

    button {
      width: 100%; padding: 1.2rem; background: var(--neon-cyan);
      color: #001a33; font-weight: 900; border: none; border-radius: 50px;
      cursor: pointer; transition: 0.3s; text-transform: uppercase;
    }
    button:hover { transform: scale(1.05); box-shadow: 0 0 30px var(--neon-cyan); }
    button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }

    #message { margin-top: 1.5rem; font-weight: bold; min-height: 1.2em; line-height: 1.4; }
    
    .status-badge {
        display: inline-block; padding: 5px 10px; border-radius: 5px; 
        font-size: 0.8rem; margin-bottom: 10px; letter-spacing: 1px;
    }
  </style>
</head>
<body>

  <div class="sun-rays"></div>
  <div class="fish fish-r2l" style="top: 20%;">üêü</div>
  <div class="fish fish-l2r" style="top: 60%;">üê†</div>

  <div class="card">
    <h2 id="cardTitle">Admin Acceptance Page</h2>

    <div id="step1" class="input-container">
      <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 20px;">
        Enter your email to request admin.
      </p>
      <input type="email" id="email" placeholder="ENTER WORK EMAIL">
    </div>

    <div id="step2" class="input-container hidden">
      <div class="status-badge" style="background: rgba(0, 255, 136, 0.2); color: var(--success-green); border: 1px solid var(--success-green);">
        ‚úì ACCESS GRANTED
      </div>
      <input type="password" id="newPassword" placeholder="NEW PASSWORD">
      <input type="password" id="confirmPassword" placeholder="CONFIRM PASSWORD">
    </div>

    <button id="actionBtn" onclick="handleAction()">CHECK PERMISSION</button>
    <div id="message"></div>
  </div>

  <script>
    let step = 1; // 1 = Check Status, 2 = Set Password
    let currentEmail = "";

    async function handleAction() {
      const msg = document.getElementById("message");
      const btn = document.getElementById("actionBtn");
      const emailInput = document.getElementById("email");
      
      msg.innerText = "";
      
      try {
        btn.disabled = true;
        btn.innerText = "PROCESSING...";

        if (step === 1) {
            // PHASE 1: CHECK STATUS / REQUEST APPROVAL
            currentEmail = emailInput.value.trim();
            if (!currentEmail) throw new Error("EMAIL REQUIRED");

            // Call backend to check status
            const res = await fetch("/api/auth/check-reset-status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: currentEmail })
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.message || "SERVER ERROR");

            // LOGIC FOR DIFFERENT STATES
            if (data.status === "APPROVED") {
                // CASE: Admin has approved!
                step = 2;
                document.getElementById("step1").classList.add("hidden");
                document.getElementById("step2").classList.remove("hidden");
                btn.innerText = "UPDATE PASSWORD";
                showMsg("ACCESS APPROVED. SET PASSWORD.", "#00ff88");
            
            } else if (data.status === "PENDING") {
                // CASE: Already requested, still waiting
                btn.innerText = "CHECK AGAIN";
                showMsg("‚è≥ PENDING ADMIN APPROVAL.\nPLEASE CONTACT HR.", "#ffdd00"); // Yellow
            
            } else if (data.status === "REQUEST_SENT") {
                // CASE: Fresh request created just now
                btn.innerText = "CHECK AGAIN";
                showMsg("‚úì REQUEST SENT TO ADMIN.\nWAIT FOR APPROVAL.", "#00f2ff"); // Cyan
            }

        } else if (step === 2) {
            // PHASE 2: UPDATE PASSWORD
            await finalReset();
        }

      } catch (err) {
        msg.innerText = err.message.toUpperCase();
        msg.style.color = "#ff4d4d"; // Red
        btn.innerText = step === 1 ? "CHECK PERMISSION" : "UPDATE PASSWORD";
      } finally {
        btn.disabled = false;
        if(step === 1 && btn.innerText === "PROCESSING...") btn.innerText = "CHECK PERMISSION";
      }
    }

    async function finalReset() {
      const pass1 = document.getElementById("newPassword").value;
      const pass2 = document.getElementById("confirmPassword").value;

      if (!pass1 || pass1.length < 6) throw new Error("PASSWORD TOO SHORT (MIN 6)");
      if (pass1 !== pass2) throw new Error("PASSWORDS MISMATCH");

      const res = await fetch("/api/auth/reset-password-approved", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: currentEmail, newPassword: pass1 })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      showMsg("‚úì PASSWORD UPDATED SUCCESSFULLY", "#00ff88");
      document.getElementById("actionBtn").style.display = "none";
      setTimeout(() => window.location.href = "/login", 2500);
    }

    function showMsg(text, color) {
      const msg = document.getElementById("message");
      msg.innerText = text;
      msg.style.color = color;
    }
  </script>
</body>
</html>
