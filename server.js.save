require("dotenv").config({
  path: require("path").join(__dirname, ".env")
});

const express = require("express");
const cors = require("cors");
const path = require("path");
const http = require("http");
const compression = require("compression");

/* =========================
   APP INIT
========================= */
const app = express();

/* =========================
   PERF: COMPRESSION (FIRST)
========================= */
app.use(compression());

/* =========================
   CORS
========================= */
app.use(
  cors({
    origin: "*",
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization"]
  })
);

/* =========================
   BODY PARSERS
========================= */
app.use(express.json({ limit: "5mb" }));
app.use(express.urlencoded({ extended: true }));

const PORT = process.env.PORT || 5000;
const NODE_ENV = process.env.NODE_ENV || "development";

/* =========================
   DB INIT (FAIL FAST)
========================= */
require("./db");

/* =========================
   CRON JOBS
========================= */
require("./cron/timesheetLockCron");

/* =========================
   WEBSOCKET INIT
========================= */
const { initWebSocket } = require("./routes/wsServer");

/* =========================
   STATIC FILES (SINGLE SOURCE OF TRUTH)
========================= */
const publicPath = path.join(__dirname, "public");

app.use(
  "/assets",
  express.static(path.join(publicPath, "assets"), {
    maxAge: "7d",
    immutable: true,
    etag: true
  })
);

app.use("/uploads", express.static(path.join(__dirname, "uploads")));

/* Serve index.html, login.html, etc */
app.use(express.static(publicPath));

/* =========================
   ROUTE LOADER (FAIL FAST)
========================= */
function requireRoute(routePath) {
  try {
    return require(routePath);
  } catch (err) {
    console.error(`âŒ Failed to load route: ${routePath}`);
    throw err;
  }
}

/* =========================
   ROUTES
========================= */
app.use("/api/auth", requireRoute("./routes/auth"));
app.use("/api/users", requireRoute("./routes/users"));
app.use("/api/employees", requireRoute("./routes/employee"));

app.use("/api/holiday", requireRoute("./routes/holiday"));
app.use("/api/team", requireRoute("./routes/team"));
app.use("/api/attendance", requireRoute("./routes/attendance"));
app.use("/api/leaves", requireRoute("./routes/leaves"));

app.use("/api/payslips", requireRoute("./routes/payslips"));
app.use("/api/payroll", requireRoute("./routes/payroll"));
app.use("/api/payroll", requireRoute("./routes/payroll-upload"));

app.use("/api/thought", requireRoute("./routes/thought"));
app.use("/api/notifications", requireRoute("./routes/notifications"));
app.use("/api/festival", requireRoute("./routes/festival"));
app.use("/api/timesheets", requireRoute("./routes/timesheets"));
app.use("/api/manager", requireRoute("./routes/manager"));
app.use("/api/documents", requireRoute("./routes/documents"));
app.use("/api/decisions", requireRoute("./routes/decisions"));
app.use("/api/executive", requireRoute("./routes/executive"));

/* =========================
   ANALYTICS
========================= */
app.use("/api/analytics/profile", requireRoute("./routes/analytics-profile"));
app.use("/api/analytics/bench", requireRoute("./routes/analytics-bench"));
app.use("/api/analytics", requireRoute("./routes/analytics"));

/* =========================
   HEALTH CHECK
========================= */
app.get("/health", (req, res) => {
  res.json({
    status: "OK",
    environment: NODE_ENV,
    uptime_seconds: Math.floor(process.uptime()),
    timestamp: new Date().toISOString()
  });
});

/* =========================
   API FALLBACK
========================= */
app.use("/api", (req, res) => {
  res.status(404).json({
    message: "API route not found",
    path: req.originalUrl
  });
});

/* =========================
   SPA FALLBACK (FINAL)
========================= */
app.get("*", (req, res) => {
  // Block API & asset requests
  if (
    req.path.startsWith("/api") ||
    req.path.startsWith("/assets") ||
    req.path.startsWith("/uploads")
  ) {
    return res.status(404).end();
  }

  // Always return SPA shell
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

/* =========================
   GLOBAL ERROR HANDLER
========================= */
app.use((err, req, res, next) => {
  console.error("âŒ Unhandled Error:", err);
  res.status(500).json({
    message: "Internal server error",
    ...(NODE_ENV !== "production" && { error: err.message })
  });
});

/* =========================
   START SERVER
========================= */
const server = http.createServer(app);
initWebSocket(server);

server.listen(PORT, () => {
  console.log(`ðŸš€ HRMS running on port ${PORT}`);
  console.log(`ðŸŒ± Environment: ${NODE_ENV}`);
});
